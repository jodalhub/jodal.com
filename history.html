<!DOCTYPE html>
<html lang="ko">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta charset="UTF-8" />
  <title>íˆ¬ì°°ê¸°ë¡ ë³´ê¸° - ì¡°ë‹¬ë‹·ì»´</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 40px; max-width: 1200px; margin: auto; }
    h1 { font-size: 26px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #f0f0f0; }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      margin-bottom: 20px;
    }
    .controls input, .controls select {
      padding: 8px;
      font-size: 14px;
    }
    .btn {
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-danger:hover { background-color: #c82333; }
    .btn-download { background-color: #28a745; color: white; }
    .btn-download:hover { background-color: #218838; }
  </style>
</head>
<body>
  <h1>ğŸ“Š íˆ¬ì°° ê¸°ë¡ ë³´ê¸°</h1>

  <div class="controls">
    <label>ìƒíƒœ:
      <select id="filterStatus" onchange="renderTable()">
        <option value="ì „ì²´">ì „ì²´</option>
        <option value="ê³„ì‚°ë§Œ í•¨">ê³„ì‚°ë§Œ í•¨</option>
        <option value="íˆ¬ì°°ì™„ë£Œ">íˆ¬ì°°ì™„ë£Œ</option>
      </select>
    </label>

    <label>ê³µê³ ëª… ê²€ìƒ‰:
      <input type="text" id="searchTitle" oninput="renderTable()" placeholder="ì˜ˆ: ì‚¬ë¬´ê¸°ê¸°">
    </label>

    <label>ê³„ì‚°ì¼ì:
      <input type="date" id="searchDate" onchange="renderTable()">
    </label>

    <button class="btn btn-download" onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    <button class="btn btn-danger" onclick="clearHistory()">ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ê³µê³ ëª…</th>
        <th>ê¸°ì´ˆê¸ˆì•¡</th>
        <th>ë‚™ì°°í•˜í•œìœ¨</th>
        <th>ì‚¬ì •ìœ¨</th>
        <th>íˆ¬ì°°ê°€</th>
        <th>ìƒíƒœ</th>
        <th>ê³„ì‚°ì¼ì‹œ</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>

  <script>
    let allHistory = JSON.parse(localStorage.getItem('bidHistory') || '[]').reverse();

    function renderTable() {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';

      const statusFilter = document.getElementById('filterStatus').value;
      const titleSearch = document.getElementById('searchTitle').value.trim().toLowerCase();
      const dateSearch = document.getElementById('searchDate').value;

      const filtered = allHistory.filter(r => {
        const matchStatus = statusFilter === 'ì „ì²´' || r.ìƒíƒœ === statusFilter;
        const matchTitle = r.ê³µê³ ëª… && r.ê³µê³ ëª….toLowerCase().includes(titleSearch);
        const matchDate = !dateSearch || (r.ê³„ì‚°ì¼ì‹œ && r.ê³„ì‚°ì¼ì‹œ.startsWith(dateSearch));
        return matchStatus && matchTitle && matchDate;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      filtered.forEach(r => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${r.ê³µê³ ëª…}</td>
          <td>${Number(r.ê¸°ì´ˆê¸ˆì•¡).toLocaleString()} ì›</td>
          <td>${r.ë‚™ì°°í•˜í•œìœ¨}%</td>
          <td>${r.ì‚¬ì •ìœ¨}%</td>
          <td>${Number(r.íˆ¬ì°°ê°€).toLocaleString()} ì›</td>
          <td>${r.ìƒíƒœ}</td>
          <td>${r.ê³„ì‚°ì¼ì‹œ}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function clearHistory() {
      if (confirm("ì •ë§ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.removeItem('bidHistory');
        location.reload();
      }
    }

    function downloadExcel() {
      const filter = document.getElementById('filterStatus').value;
      const title = document.getElementById('searchTitle').value.trim().toLowerCase();
      const date = document.getElementById('searchDate').value;

      const filtered = allHistory.filter(r => {
        const matchStatus = filter === 'ì „ì²´' || r.ìƒíƒœ === filter;
        const matchTitle = r.ê³µê³ ëª… && r.ê³µê³ ëª….toLowerCase().includes(title);
        const matchDate = !date || (r.ê³„ì‚°ì¼ì‹œ && r.ê³„ì‚°ì¼ì‹œ.startsWith(date));
        return matchStatus && matchTitle && matchDate;
      });

      if (filtered.length === 0) {
        alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const data = filtered.map(r => ({
        ê³µê³ ëª…: r.ê³µê³ ëª…,
        ê¸°ì´ˆê¸ˆì•¡: r.ê¸°ì´ˆê¸ˆì•¡,
        ë‚™ì°°í•˜í•œìœ¨: r.ë‚™ì°°í•˜í•œìœ¨,
        ì‚¬ì •ìœ¨: r.ì‚¬ì •ìœ¨,
        íˆ¬ì°°ê°€: r.íˆ¬ì°°ê°€,
        ìƒíƒœ: r.ìƒíƒœ,
        ê³„ì‚°ì¼ì‹œ: r.ê³„ì‚°ì¼ì‹œ
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "íˆ¬ì°°ê¸°ë¡");

      const dateStr = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `bid_history_${dateStr}.xlsx`);
    }

    renderTable();
  </script>
</body>
</html>